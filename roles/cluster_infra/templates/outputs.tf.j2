# This is used to determine the image to use unless explicitly patching
output "cluster_image" {
  description = "The id of the image used to build the cluster nodes"
  value       = "{{ cluster_previous_image | default(cluster_image) }}"
}

output "cluster_gateway_ip" {
  description = "The IP address of the gateway used to contact the cluster nodes"
  value       = "${openstack_networking_floatingip_v2.fl_ip_router.address}"
}

locals {
   router_private_ip = [for each in openstack_compute_instance_v2.router.network : each.fixed_ip_v4 if each.name == "{{ private_network.name }}"]

   priv_network = {
     for priv in openstack_compute_instance_v2.private_instance:
        priv.name => [for each in priv.network : each.fixed_ip_v4 if each.name == "{{ private_network.name }}"][0]
   }
}

output "cluster_nodes" {
  description = "A list of the nodes in the cluster from which an Ansible inventory will be populated"
  value       = concat(
    [
      {
        name          = openstack_compute_instance_v2.router.name
        ip            = local.router_private_ip[0]
        groups        = ["routers"],
        facts  = {
          openstack_project_id = "${data.openstack_identity_auth_scope_v3.scope.project_id}"
        }
      }
    ],
    [
      for priv in openstack_compute_instance_v2.private_instance: {
        name          = "${priv.name}"
        ip            = local.priv_network[priv.name]
        groups        = ["private"],
        facts  = {
          openstack_project_id = "${data.openstack_identity_auth_scope_v3.scope.project_id}"
        }
      }
    ]
  )
}

output "router_private_ip" {
  description = "The IP address of the router on the private network"
  value       = local.router_private_ip[0]
}
